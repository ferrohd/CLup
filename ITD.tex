\input{preamble}
\graphicspath{ {assets/} }
\usepackage{dirtree}

\titlepicture[width=0.75\textwidth]{./polimi_logo}
\title{Implementation and Test Deliverable}
\subtitle{Customers Line-up}
\linklist{
    \href{https://github.com/ferrohd/FerraraFratus/tree/main/DeliveryFolder}{Installer} - 
    \href{https://github.com/ferrohd/FerraraFratus/tree/main/CLup}{Source code}
}
\author{\href{https://github.com/ferrohd}{Alessandro Ferrara} -
\href{https://github.com/lorenzofratus}{Lorenzo Fratus}}
\professor{Elisabetta di Nitto}
\date{February 05, 2021}
\version{1.0}

\begin{document}

\maketitle

\tableofcontents

\chapter{1. Introduction}

\section{A. Purpose}

The purpose of this document is to present the work done during the implementation of the first prototype of this application.

This document presents a summary of the functions that are available in the current version of the software and an overview of the languages and frameworks used during the development.

Finally, it outlines the tests that have been carried out and presents a simple installation guide.

Together with the RASD and the DD, this document has the purpose to inform about the realization of the software called Customers Line-up.

\section{B. Scope}

As better explained in the previous documents, the software wants to foster a safe shopping experience by providing a customer flow control system. This system should allow the users to avoid crowds both inside and outside the stores.

The system should be very simple to use (to adapt to all demographics) and provide fallback options for those who do not have access to the application.

\section{C. Definitions, acronyms and abbreviations}

\subsection{C.1. Definitions}

\begin{itemize}
\item
  \textbf{User}: person which is correctly registered to the system, it abstracts the concepts of clupper and store manager.
\item
  \textbf{Customer}: person which wants to enter a store, it abstracts the concepts of clupper and guest.
\item
  \textbf{Clupper}: person (both user and customer) which is able to use the basic services offered by CLup (join a queue and book a visit).
\item
  \textbf{Guest}: person (customer) which is not registered to the system or that is currently unable to use the application, and therefore cannot take advantage of the services offered by CLup.
\item
  \textbf{Store manager}: person (user) which is able to use the managerial services offered by CLup.
\item
  \textbf{Store}: physical business registered to the system (by registering his store manager).
\item
  \textbf{Store capacity}: maximum number of customers allowed inside a store (according to the regulations currently in force it corresponds to half of the capacity of the building).
\item
  \textbf{Ticket}: QR code issued to a user as a receipt for queuing or booking at a store. It can be digital or physical and grants the access to the store based on the transaction that generated it.
\item
  \textbf{Valid ticket}: a ticket is valid if the store contained in it matches the one of the store manager which scanned it and:
  \begin{itemize}
  \tightlist
  \item
    the ticket is the first in the store queue, if the ticket has been generated by a ``Join a queue'' function;
  \item
    the time slots linked to the ticket include the current timestamp, if the ticket has been generated by a ``Book a visit'' function;
  \end{itemize}
\item
  \textbf{Queue}: imaginary list of tickets, bound to a store, ordered by their time of issue, it does not contain tickets of customers with a reservation.
\end{itemize}

\subsection{C.2. Acronyms}

\begin{itemize}
\item
  \textbf{RASD}: Requirement Analysis and Specification Document.
\item
  \textbf{DD}: Design Document.
\item 
  \textbf{ITD}: Implementation and Testing Deliverable.
\item
  \textbf{GPS}: Global Positioning System.
\end{itemize}

\subsection{C.3. Abbreviations}

\begin{itemize}
\item
  \textbf{CLup}: Customers Line-up.
\end{itemize}

\clearpage
\section{D. Revision history}

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 2\tabcolsep) * \real{0.10}}
  >{\raggedright\arraybackslash}p{(\columnwidth - 2\tabcolsep) * \real{0.45}}
  >{\raggedright\arraybackslash}p{(\columnwidth - 2\tabcolsep) * \real{0.45}}@{}}
\toprule
Version & Date & Description \\ \addlinespace
\midrule
\endhead
1.0 & 05 Feb 2021 & First version \\ \addlinespace
\bottomrule
\end{longtable}

\section{E. Reference documents}

\begin{itemize}
\item
  Assignment document A.Y. 2020/2021 (``Requirement Engineering and Design Project: goal, schedule, and rules'')
\item
  Assignment document A.Y. 2020/2021 (``I\&T assignment goal, schedule, and rules'')
\item
  Requirement Analysis and Specification Document - Customers Line-up, version 1.1 (referred to as ``RASD'' in the document)
\item
  Design Document - Customers Line-up, version 1.1 (referred to as ``DD'' in the document)
\end{itemize}

\section{F. Document structure}

\begin{itemize}
\item 
    \textbf{Section 1: Introduction}: The first section provides an introduction to the purpose of the document and the scope of the CLup system. Included here is a glossary with the definitions, acronyms and abbreviations used in this document.
\item 
    \textbf{Section 2: Product functions}: This section is a reference to the previous documents. Here are presented the functions that are actually implemented in the software and those that are not (together with the motivation for excluding them).
\item 
    \textbf{Section 3: System development frameworks}: In this section are explained the adopted development framework which also includes an overview of the adopted programming languages, middlewares and APIs.
\item 
    \textbf{Section 4: Source code structure}: This section contains the structure of the source code, with some information about the content of the main folders.
\item 
    \textbf{Section 5: Testing activity}: Here is specified how the system have been tested and are described the main test cases and their outcome.
\item 
    \textbf{Section 6: Installation guide}: This section includes a simple installation guide.
\end{itemize}

\chapter{2. Product functions}

\section{A. Implemented functions}

\subsection{A.1. Join a queue (digital)}

This function allows a clupper to line up for the desired store without having to immediately reach the store.
After selecting a supermarket from the list the clupper will be able to see its details (name, address, number of customers already in line) and to join the queue.
The system will provide the clupper with a digital ticket, which he will be able to see directly from the application.
Finally, the clupper is able to leave the queue at any time before entering the store, this results in the deletion of his ticket.

\subsection{A.2. Join a queue (physical)}

This function is a fallback of the first one, indeed, it allows the store manager to insert into the queue any guest requesting it.
The system will provide the store manager with a digital ticket, which he will have to convert into physical (by printing it) and hand out to the guest.
Finally, the guest is able to leave the queue at any time before entering the store, by asking the store manager to delete his ticket.

\subsection{A.3. Store overview}

This function allows a store manager to have a live overview of the store.
The system will provide the store manager with the number of customers inside the store (compared to the capacity) and those in the store queue.
This data should allow him to regulate the flow of customers.
This function also offers to the store manager the possibility to update the store capacity in order to adapt to the latest regulations.

\clearpage
\subsection{A.4. Ticket scan}

This function allows a store manager to scan (and validate) a customerâ€™s ticket (both at the entrance and the exit of the store).
This has the double purpose of updating the data contained into the store overview, and make sure that the flow of customers corresponds to that expected by the system (no one is able to enter before his turn).

\section{B. Discarded functions and details}

This is a list of functions or functional details that are described in the previous documents but have been excluded from the implementation of the system, mostly due to its prototypical nature.
\begin{itemize}
  \item \textbf{Book a visit function}: this advanced functionality was not required by the assignment document.
  \item \textbf{Opening time of stores}: this detail was directly connected with the implementation of the \emph{Book a visit} function, it should have been used to calculate the available time slots for each store.
  \item \textbf{User notifications}: the option to notify the clupper to approach the store requires to monitor his position, this was not possible with the adopted API.
  \item \textbf{Map exploration and search by address}: this minor functionalities have been discarded because not available with the adopted API (more on that in the next chapter).
\end{itemize}

\section{C. Other changes}

Differently from what shown in the DD:
\begin{itemize}
  \item \textbf{On the web tier}: there is no \emph{load balancer} to distribute the load between multiple instances of the application tier.
  \item \textbf{On the application tier}: there is no \emph{PM2 process manager}, a docker-like process manager to spawn multiple instances.
\end{itemize}
These modules are not mission-critical and have been avoided in order to focus on other (more important) aspects of the system.

\chapter{3. System development frameworks}

\section{A. Adopted frameworks}

To facilitate the development process, the application has been built starting from already existing frameworks.
\begin{itemize}
  \item \textbf{\href{https://www.npmjs.com/package/express}{Express}}: as already shown in the DD, the system business logic resides on a server running on NodeJS.
  ExpressJS is considered the \emph{de facto} web framework for this type of execution environment.
  \item \textbf{\href{https://www.npmjs.com/package/mocha}{Mocha}}: is the testing framework that provides all the functions and interfaces used to test and benchmark the software.
\end{itemize}

\section{B. Adopted programming languages}

\subsection{B.1. JavaScript}

The whole logic of the system has been written using JavaScript ES6, an high-level just-in-time compiled programming language that, together with HTML and CSS, is one of the core technologies of the WWW.\\
In this application, the logic is almost completely on the web and application servers, with the workload on the client side only responsible for making the page interactive.

\subsubsection{B.1.1. JavaScript Pros}

\begin{itemize}
  \item \textbf{Weakly Typed}: being weakly typed allows a lot of flexibility that let us develop faster and change things quickly.
  \item \textbf{I/O driven}: NodeJS operates on a event loop which means, thanks to the asynchronous behavior that it can handle thousands of concurrent connections.
  \item \textbf{Widely used}: it's the most used programming language, which means it is heavily documented and makes the system highly maintainable.
\end{itemize}

\subsubsection{B.1.2. JavaScript Cons}

\begin{itemize}
  \item \textbf{Weakly Typed}: a weakly typed programming languages is prone to errors.
  \item \textbf{Callback Hell}: due to the asynchronous nature of JS, situations in which there are multiple levels of nested callbacks, can affect the system performance very easily.
\end{itemize}

\subsection{B.2. Other languages}

In addition to JS, HTML and CSS has been used to build the structure and appearance of each web page.

\section{C. Adopted middlewares}

Here a list of the middlewares that have been used to add functionalities to the application server.
\begin{itemize}
  \item \textbf{\href{https://www.npmjs.com/package/cookie-parser}{Cookie Parser}}: used to parse cookies contained in the incoming requests.
  \item \textbf{\href{https://www.npmjs.com/package/express-session}{Express Session}}: used to manage user sessions on the application tier.
  \item \textbf{\href{https://www.npmjs.com/package/pug}{Pug}}: template engine, used to perform server-side rendering of HTML pages.
\end{itemize}

Generally speaking, using a middleware has several advantages including:
\begin{itemize}
  \item \textbf{Already developed}: there is no need to reinvent the wheel, using an already developed module to provide a standard function saves time and resources.
  \item \textbf{Field-tested}: external modules are commonly used in development, this typically ensures that it is well functioning and that any new feature is tested by a lot of developers.
\end{itemize}
The only drawback compared to a custom-made middleware is that the developer has to adapt to the interfaces offered by an external module.\\
However, with JavaScript being a widely used language, there is plenty of alternatives available.

\clearpage
\subsection{C.3. Other libraries}

This is a list of external libraries that are not middlewares but have played a key role in the implementation of this system.
\begin{itemize}
  \item \textbf{\href{https://www.npmjs.com/package/request}{Request}}: used to allow HTTP request to the APIs.
  \item \textbf{\href{https://www.npmjs.com/package/mysql}{MySQL}}: used to perform queries on the DB.
  \item \textbf{\href{https://www.npmjs.com/package/qrcode}{QrCode}}: used to encode ticket ID's into png images.
  \item \textbf{\href{https://www.npmjs.com/package/haversine-distance}{Haversine Distance}}: used to calculate the distance between two GPS locations.
  \item \textbf{\href{https://www.npmjs.com/package/superagent}{Superagent}}: testing, simulates an HTTP client.
  \item \textbf{\href{https://www.npmjs.com/package/chai}{Chai}}: testing, provides an assertion library.
\end{itemize}

\section{E. Adopted APIs}

\subsection{E.1. Discarded API}

Unlike what is suggested in the Design Document, the implemented system does not relies on \emph{Google Maps Javascript API} to provide GPS-related functions.\\
Even if it is clearly the best solution to build the definitive version of this application, this API requires a lot of time to be mastered to have access to all its functionalities.\\
Being this the implementation of a prototype, the main concern has been to build a version of the application that is able to provide the most important features.

\subsection{E.2. Replacement API}

To replace the discarded Maps API, a simpler but equally reliable service has been used: \href{https://positionstack.com/documentation}{PositionStack API}.\\
This API enables our application to perform a conversion from a GPS position (expressed by means of latitude and longitude) to an address and back.\\
This conversion involves minimal error (that can lead to a wrong civic number) that was deemed acceptable in favor of a faster implementation.\\
Moreover, due to the way in which this API is implemented, the conversion is possible only by region (in this case only \emph{Lombardia}). This limit could be canceled in the future for example by asking the user to select his region in the registration process.

\chapter{4. Source code structure}

This is a simple directory tree that shows the structure of our source code.

\dirtree{%
  .1 /.
    .2 src.
      .3 model\\\DTcomment{Model of the system, to enable the usage of the proxy pattern}.
      .3 view.
        .4 css\\\DTcomment{CSS files to define the aspect of the pages}.
        .4 js\\\DTcomment{Client-side JS code used in some pages}.
        .4 img\\\DTcomment{Static images used in some pages}.
        .4 include\\\DTcomment{Static imports shared through all the pages}.
        .4 template\\\DTcomment{Pug templates for HTML pages}.
      .3 controller.
        .4 database\\\DTcomment{Controller that handles DB connections with a connection pool}.
        .4 middlewares\\\DTcomment{Custom middlewares that handle authentication and authorization}.
        .4 routes\\\DTcomment{Routes (APIs) provided by the application}.
        .4 services\\\DTcomment{Exposed services accessed by the routes to carry out business logic}.
        .4 server.js\\\DTcomment{Initializes the routes and the middlewares}.
      .3 index.js\\\DTcomment{Main method that runs the server}.
    .2 test\\\DTcomment{Tests performed on the system}.
}

\chapter{5. Testing activity}

\section{A. Testing environment}

To ensure a testing activity as close as possible to a real-world scenario, the test suite was run directly using the production database rather than a custom-made stub.

In order to stimulate the system, a mock HTTP client was introduced thanks to an external module.
This client has the task of performing multiple actions on the available services and verifying that the response matches the expected result for each test.

Due to the small size of the public interface classes, to avoid trivial tests, the test cases focus specifically on the routes of the web server.
These components directly interact with the public interfaces, in this way, a complete test suite is guaranteed.

The objective of this activity is to cover the requirements highlighted in the RASD in order to ensure that the system is able to meet them.
The test cases are grouped according to the public interface they refer to.

\clearpage
\section{B. Test cases}

\subsection{B.1. Account routes}

The testing of the account routes begins with the initialization of the CLup application and the instantiation of a HTTP client to perform the testing.

The following tests are done:
\begin{enumerate}
    \item Login:
        \begin{itemize}
            \item Login of a clupper
            \item Login of a store manager
            \item Login with invalid credentials
        \end{itemize}
    \item Registration of a clupper:
        \begin{itemize}
            \item Registration with valid information
            \item Registration with missing information
            \item Registration with email already in use
        \end{itemize}
    \item Registration of a store manager:
        \begin{itemize}
            \item Registration with valid information
            \item Registration with missing information
            \item Registration with email already in use
            \item Registration with VAT already in use
        \end{itemize}
\end{enumerate}

All the test are passed. The benchmark results are under 1000ms.

\subsection{B.2. Clupper routes}

As in the account routes testing, the procedure initializes both CLup application and a HTTP client.
All the tests are carried out sequentially (the first one is always the login).

The following tests are done:
\begin{enumerate}
    \item Store retrieval:
        \begin{itemize}
            \item See the list of stores
            \item See the details of a store
            \item See the details of an invalid store
        \end{itemize}
    \clearpage
    \item Queue management:
        \begin{itemize}
            \item See the details of the queue ticket
            \item See the details of the queue ticket when the clupper is not in a queue
            \item Join the queue of a store
            \item Join the queue of an invalid store
            \item Leave the queue of a store
            \item Leave the queue of an invalid store
        \end{itemize}
\end{enumerate}

All the test are passed. The benchmark results are under 600ms.

\subsection{B.3. Store manager routes}

The testing of the store manager routes proceeds in the same way as the testing of the clupper ones (always starting from the login).

The following tests are done:
\begin{enumerate}
    \item Capacity update:
        \begin{itemize}
            \item Update the capacity with a valid value
            \item Update the capacity with an invalid value
        \end{itemize}
    \item Ticket scan:
        \begin{itemize}
            \item Scan at the entrance
            \item Scan at the exit
            \item Scan of a non-existing ticket
            \item Scan of a ticket that is not the head of the queue
            \item Scan of a ticket when maximum capacity is reached
        \end{itemize}
    \item Other ticket operations:
        \begin{itemize}
            \item See the list of issued tickets
            \item Issue a new ticket
            \item Delete an issued ticket
        \end{itemize}
\end{enumerate}

All the test are passed. The benchmark results are under 600ms.

\clearpage
\subsection{B.4. Middlewares}

Some small tests are also performed to ensure that the middlewares are activated at the right time.

The following tests are done:
\begin{enumerate}
    \item No login:
        \begin{itemize}
            \item Access explore page without login
            \item Access overview page without login
        \end{itemize}
    \item Clupper:
        \begin{itemize}
            \item Access explore page with login
            \item Access overview page with login
        \end{itemize}
    \item Store manager:
        \begin{itemize}
            \item Access explore page with login
            \item Access overview page with login
        \end{itemize}
\end{enumerate}

All the test are passed. The benchmark results are under 600ms.

\section{C. Additional features}

Together with each test case, a benchmark is automatically run to measure the performance of the system in terms of time required to complete the tasks.
The result of the benchmark could vary a lot depending on the network speed and hardware it is running on.

\chapter{6. Installation guide}

A detailed installation guide, complete with images, can be found in the \emph{README} file contained both in the installation folder and in the GitHub repository at this \underline{\href{https://github.com/ferrohd/FerraraFratus/tree/main/CLup}{link}}.

\chapter{7. Effort spent}

\section{Pair programming}

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 2\tabcolsep) * \real{0.8}}
  >{\raggedleft\arraybackslash}p{(\columnwidth - 2\tabcolsep) * \real{0.2}}@{}}
\toprule
Topic & Hours \\ \addlinespace
\midrule
\endhead
Sections 2, 3 and 4 & 3.0h \\ \addlinespace
\bottomrule
\end{longtable}

\section{Ferrara Alessandro}

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 2\tabcolsep) * \real{0.8}}
  >{\raggedleft\arraybackslash}p{(\columnwidth - 2\tabcolsep) * \real{0.2}}@{}}
\toprule
Topic & Hours \\ \addlinespace
\midrule
\endhead
Installation guide & 0.5h \\ \addlinespace
Section 5 & 1.5h \\ \addlinespace
\bottomrule
\end{longtable}

\section{Fratus Lorenzo}

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 2\tabcolsep) * \real{0.8}}
  >{\raggedleft\arraybackslash}p{(\columnwidth - 2\tabcolsep) * \real{0.2}}@{}}
\toprule
Topic & Hours \\ \addlinespace
\midrule
\endhead
Section 1 & 1.0h \\ \addlinespace
Section 5 revision & 1.0h \\ \addlinespace
\bottomrule
\end{longtable}

\end{document}